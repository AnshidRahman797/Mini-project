<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Header</title>
    <link rel="stylesheet" href="styles2.css">
    <script src="https://kit.fontawesome.com/ab05a6b4fa.js" crossorigin="anonymous"></script>
</head>

<script type="module">

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAx3LcZnN2DSwx-YLdvG7an0Mgnr4NlQXk",
        authDomain: "event-management-6eab1.firebaseapp.com",
        projectId: "event-management-6eab1",
        storageBucket: "event-management-6eab1.firebasestorage.app",
        messagingSenderId: "792652272458",
        appId: "1:792652272458:web:0aa7019690d73b7801e7b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const filters = {
        eventType: "",
        state: "",
        city: "",
        college: "",
        date: "",
        searchQuery: ""
    };

    async function loadEvents() {
        const eventsContainer = document.querySelector(".feature-grid");
        eventsContainer.innerHTML = ""; 

        let eventsRef = collection(db, "verified_events");
        const conditions = [];

        if (filters.eventType) conditions.push(where("event_type", "==", filters.eventType));
        if (filters.state) conditions.push(where("state", "==", filters.state));
        if (filters.city) conditions.push(where("city", "==", filters.city));
        if (filters.college) conditions.push(where("college", "==", filters.college));
        if (filters.date) conditions.push(where("start_date", "==", filters.date));

        let q = conditions.length > 0 ? query(eventsRef, ...conditions) : eventsRef;

        try {
            const querySnapshot = await getDocs(q);
            let events = [];

            querySnapshot.forEach((doc) => {
                events.push(doc.data());
            });

            // 🔍 Apply Search Filter (Client-Side)
            if (filters.searchQuery) {
                events = events.filter(event => event.event_name.toLowerCase().includes(filters.searchQuery.toLowerCase()));
            }

            if (events.length === 0) {
                eventsContainer.innerHTML = "<p>No events found.</p>";
                return;
            }

            events.forEach((event) => {
                const eventHTML = document.createElement("div");
                eventHTML.classList.add("feature-container");
                eventHTML.innerHTML = `
                    <div class="feature-card" data-event-name="${event.event_name}" data-event-date="${event.start_date}">
                        <span class="notify-icon" title="Set Notification">
                            <i class="fa-regular fa-bell"></i>
                        </span>
                        <span class="feature-hover-text">${event.event_caption || "Special Event"}</span>
                        <img src="data:image/png;base64,${event.event_image_base64}" alt="${event.event_name}">
                    </div>
                    <div class="feature-details">
                        <h3 class="feature-title">${event.event_name}</h3>
                        <p class="feature-author">on&nbsp;&nbsp;&nbsp;<strong>${event.start_date}</strong></p>
                    </div>
                `;

                // Event card click = open popup
                eventHTML.querySelector(".feature-card").addEventListener("click", (e) => {
                    // Prevent clicking on notify icon from triggering popup
                    if (e.target.closest(".notify-icon")) return;
                    showEventPopup(event);
                });

                // Notification icon logic
                const notifyIcon = eventHTML.querySelector(".notify-icon");
                const eventName = event.event_name;
                const eventDate = event.start_date;

                let reminders = JSON.parse(localStorage.getItem("reminders") || "[]");
                const isEnabled = reminders.some(r => r.name === eventName && r.date === eventDate);
                if (isEnabled) {
                    notifyIcon.innerHTML = `<i class="fa-solid fa-bell"></i>`;
                }

                notifyIcon.addEventListener("click", () => {
                    let reminders = JSON.parse(localStorage.getItem("reminders") || "[]");
                    const index = reminders.findIndex(r => r.name === eventName && r.date === eventDate);
                    
                    if (index === -1) {
                        // Add Notification
                        reminders.push({ name: eventName, date: eventDate });
                        notifyIcon.innerHTML = `<i class="fa-solid fa-bell"></i>`;
                        alert(`🔔 ${eventName} will notify you on ${eventDate}`);
                    } else {
                        // Remove Notification
                        reminders.splice(index, 1);
                        notifyIcon.innerHTML = `<i class="fa-regular fa-bell"></i>`;
                        alert(`🚫 Notification removed for ${eventName}`);
                    }

                    localStorage.setItem("reminders", JSON.stringify(reminders));
                });

                eventsContainer.appendChild(eventHTML);
            });

        } catch (error) {
            console.error("Error fetching events:", error);
            eventsContainer.innerHTML = "<p>Error loading events.</p>";
        }
    }

    // Update Filters and Search Query
    function updateFilters() {
        filters.eventType = document.querySelector("#eventType").value;
        filters.state = document.querySelector("#state").value;
        filters.city = document.querySelector("#city").value;
        filters.college = document.querySelector("#college").value;
        filters.date = document.querySelector("#date").value;
        filters.searchQuery = document.querySelector("#search-box").value.trim();

        loadEvents();
    }

    document.addEventListener("DOMContentLoaded", () => {
        // Dropdown Filter Listeners
        document.querySelectorAll(".dropdown-menu").forEach((dropdown) => {
            dropdown.addEventListener("change", updateFilters);
        });

        // 🔍 Search Functionality
        document.querySelector("#search-btn").addEventListener("click", updateFilters);
        document.querySelector("#search-box").addEventListener("keypress", (event) => {
            if (event.key === "Enter") updateFilters();
        });

        // Reset Filters & Search
        document.querySelector(".reset-btn").addEventListener("click", () => {
            document.querySelectorAll(".dropdown-menu, #search-box, #date").forEach((input) => {
                input.value = "";
            });

            Object.keys(filters).forEach(key => filters[key] = "");
            loadEvents();
        });

        loadEvents();
    });


        // ✅ Popup Creator
        function showEventPopup(event) {
            const popup = document.createElement("div");
            popup.classList.add("event-popup");

            popup.innerHTML = `
                <div class="popup-content">
                    <span class="popup-close">&times;</span>
                    <div class="popup-left">
                        <img src="data:image/png;base64,${event.event_image_base64}" alt="${event.event_name}" class="popup-image">
                    </div>
                    <div class="popup-right">
                        <h2>${event.event_name}</h2>
                        <p><strong>Location:</strong> ${event.college}, ${event.city}, ${event.state}</p>
                        <p><strong>Start Date:</strong> ${event.start_date}</p>
                        <p><strong>Contact:</strong> ${event.contact_number}</p>
                        <p><strong>Email:</strong> ${event.contact_email}</p>
                        <p><strong>Event Type:</strong> ${event.event_type}</p>
                        <p><strong>Event Fee:</strong> ${event.event_fee || "Free"}</p>
                        <p><strong>Description:</strong> ${event.event_description}</p>
                        <p><strong>Caption:</strong> ${event.event_caption}</p>
                    </div>
                </div>
            `;

            document.body.appendChild(popup);

            // Close when clicking the close button
            popup.querySelector(".popup-close").addEventListener("click", () => popup.remove());

            // Close when clicking outside
            popup.addEventListener("click", (e) => {
                if (e.target === popup) popup.remove();
            });
        }



</script>
  

<body>
    <header class="navbar">
        <a href="index.html"><div class="logo">K.</div></a>
        <div class="search-container">
            <input type="text" placeholder="Search for College Events" id="search-box">
            <button id="search-btn"><i class="fas fa-search"></i></button>
        </div>
        <div class="auth-buttons">
            <a href="profile.html" style="color: inherit;">
            <div class="profile-icon" id="profileIcon">
                <i class="fas fa-user-circle"></i>
            </div> </a>
            <a href="createevent.html">
            <button class="btn-pro">Create Event</button>
            </a>
        </div>
    </header>

    <div class="filter-section">
        <div class="filters">
            <select id="eventType" class="dropdown-menu">
                <option value="" disabled selected hidden>Event Type</option>
                <option value="Techfest">Tech Fest</option>
                <option value="Workshop">Workshop</option>
                <option value="Hackathon">Hackathon</option>
                <option value="Celebration">Celebration</option>
            </select>
            
            <select id="state" class="dropdown-menu">
                <option value="" disabled selected hidden>State</option>
                <option value="Andhra Pradesh">Andhra Pradesh</option>
                <option value="Karnataka">Karnataka</option>
                <option value="Tamil Nadu">Tamil Nadu</option>
                <option value="Kerala">Kerala</option>
                <option value="Maharashtra">Maharashtra</option>
                <option value="Punjab">Punjab</option>
            </select>
            
            <select id="city" class="dropdown-menu">
                <option value="" disabled selected hidden>City</option>
                <option value="Palakkad">Palakkad</option>
                <option value="Kochi">Kochi</option>
            </select>
            
            <select id="college" class="dropdown-menu">
                <option value="" disabled selected hidden>College</option>
                <option value="Government Engineering College, Sreekrishnapuram">GEC Palakkad</option>
                <option value="NSS College of Engineering">NSS Palakkad</option>
            </select>
            
            <input type="date" id="date" class="dropdown-menu">

        </div>
            <button class="reset-btn">Reset filters</button>
    </div>

    <section class="feature-section">
        <div class="feature-grid">
            
        </div>
    </div>

    
</body>
</html>