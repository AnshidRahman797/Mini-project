<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel</title>
  <link rel="stylesheet" href="adminpanel.css" />
  <script src="https://kit.fontawesome.com/ab05a6b4fa.js" crossorigin="anonymous"></script>
</head>

<body>
  <header class="navbar">
    <a href="index.html">
      <div class="logo">K.</div>
    </a>
    <div class="menu-toggle" onclick="toggleSidebar()">&#9776;</div>
    <div class="heading">ADMIN PANEL</div>
  </header>

  <!-- Sidebar Navigation -->
  <div class="sidebar" id="sidebar">
    <div class="menu-items" id="menuItems">
      <a href="#" onclick="showSection('scraped-data', event)">Scraped Data</a>
      <a href="#" onclick="showSection('user-events', event)">User-Entered Events</a>
      <a href="#" onclick="showSection('settings', event)">Settings</a>
    </div>
  </div>

  <!-- Sections -->
  <section id="scraped-data">
    <h2>Scraped Data</h2>
    <div class="feature-grid scraped-content"></div>
  </section>

  <section id="user-events" style="display: none;">
    <h2>User-Entered Events</h2>
    <div class="feature-grid user-events-content"></div>
  </section>

  <section id="settings" style="display: none;">
    <section id="settingsm">
      <div id="successMessage" style="display: none;"></div>
      <h2>Settings</h2>
      <div class="setting-item">
        <button id="scrapeBtn" class="btn">Click here for starting scraping</button>
      </div>
      <div class="setting-item">
        <button id="addProfileBtn" class="btn">Add New Profile</button>
      </div>
      <div class="setting-item">
        <button id="promoteAdminBtn" class="btn">Promote User to Admin</button>
      </div>
      <div class="setting-item">
        <button id="removeProfileBtn" class="btn">Remove Profile</button>
      </div>
      
      <!-- Place the modal near the bottom of the body -->
      <div id="promoteAdminModal" class="modal">
        <div class="modal-content">
          <span class="close">&times;</span>
          <h3>Promote User to Admin</h3>
          <input type="text" id="adminUsernameInput" placeholder="Enter username" />
          <button id="promoteAdminSubmitBtn" class="btn">Promote</button>
        </div>
      </div>
    </section>
    <section id="profileListSection">
      <h2>Current Scraping Profiles</h2>
      <ul id="profileList"></ul>
      <button id="refreshProfilesBtn" class="btn">Refresh List</button>
    </section>
    <!-- Modal for adding new profile -->
    <div id="addProfileModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Add New Profile</h3>
        <input type="text" id="newProfileInput" placeholder="Enter profile username" />
        <button id="saveProfileBtn" class="btn">Save Profile</button>
      </div>
    </div>
    <div id="removeProfileModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Remove Profile</h3>
        <input type="text" id="removeProfileInput" placeholder="Enter profile username to remove" />
        <button id="removeProfileSubmitBtn" class="btn">Remove Profile</button>
      </div>
    </div>
  </section>

  <!-- Firebase and Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      setDoc,
      deleteDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAx3LcZnN2DSwx-YLdvG7an0Mgnr4NlQXk",
      authDomain: "event-management-6eab1.firebaseapp.com",
      projectId: "event-management-6eab1",
      storageBucket: "event-management-6eab1.firebasestorage.app",
      messagingSenderId: "792652272458",
      appId: "1:792652272458:web:0aa7019690d73b7801e7b3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function fetchScrapedData() {
  const section = document.querySelector(".scraped-content");
  section.innerHTML = "";

  const querySnapshot = await getDocs(collection(db, "instagram_posts"));
  
  querySnapshot.forEach((docSnap) => {
    const data = docSnap.data();
    const docId = docSnap.id;

    if (!data.image_base64 || data.image_base64.length < 100) return; // skip broken images

    const card = document.createElement("div");
    card.classList.add("feature-card");

    card.innerHTML = `
      <div class="image-wrapper">
        <img src="data:image/jpeg;base64,${data.image_base64}" class="feature-image" />
        <div class="dot-menu-wrapper">
          <div class="dot-menu">&#8942;</div>
          <div class="dot-dropdown hidden">
            <div class="dropdown-item" data-id="${docId}" data-action="enter">Enter</div>
            <div class="dropdown-item" data-id="${docId}" data-action="delete">Delete</div>
          </div>
        </div>
      </div>
    `;

    // Attach dropdown logic
    const menuWrapper = card.querySelector(".dot-menu-wrapper");
    const dropdownItems = card.querySelectorAll(".dropdown-item");

    menuWrapper.querySelector(".dot-menu").addEventListener("click", (e) => {
      e.stopPropagation();
      document.querySelectorAll(".dot-dropdown").forEach(d => d.classList.add("hidden"));
      menuWrapper.querySelector(".dot-dropdown").classList.toggle("hidden");
    });

    dropdownItems.forEach(item => {
  item.addEventListener("click", async (e) => {
    const action = e.target.dataset.action;
    const id = e.target.dataset.id;
    // Assume you have your 'data' object from somewhere (e.g., already fetched scraped data)
    if (action === "enter") {
      // Instead of encoding data into the URL, store it in sessionStorage
      const eventData = {
        image_base64: data.image_base64,
        caption: data.caption || ""
      };
      sessionStorage.setItem("eventData", JSON.stringify(eventData));
      
      // Redirect without passing large data in the URL
      window.location.href = "enter-details.html";
    }else if (action === "delete") {
          if (confirm("Are you sure you want to delete this post?")) {
            await deleteDoc(doc(db, "instagram_posts", id));
            alert("Deleted!");
            fetchScrapedData();
          }
        }
      });
    });

    section.appendChild(card);
  });

  document.addEventListener("click", () => {
    document.querySelectorAll(".dot-dropdown").forEach(d => d.classList.add("hidden"));
  });
}


    async function fetchUserEvents() {
      const section = document.querySelector(".user-events-content");
      section.innerHTML = "";
      const querySnapshot = await getDocs(collection(db, "events"));
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        data.id = docSnap.id;
        const card = document.createElement("div");
        card.classList.add("feature-card");
        const imgElement = document.createElement("img");
        imgElement.src = `data:image/jpeg;base64,${data.event_image_base64}`;
        imgElement.classList.add("feature-image");
        const eventName = document.createElement("h3");
        eventName.textContent = data.event_name;
        eventName.classList.add("event-name");
        card.appendChild(imgElement);
        card.appendChild(eventName);
        section.appendChild(card);
        card.addEventListener("click", function () {
          showEventPopup(data);
        });
      });
    }

    function showEventPopup(eventData) {
      const eventId = eventData.id;
      const existingPopup = document.querySelector(".event-popup");
      if (existingPopup) existingPopup.remove();
      const popup = document.createElement("div");
      popup.classList.add("event-popup");
      popup.innerHTML = `
        <div class="popup-content">
          <span class="close-btn">&times;</span>
          <div class="popup-left">
            <img src="data:image/jpeg;base64,${eventData.event_image_base64}" class="popup-image">
          </div>
          <div class="popup-right">
            <h2>${eventData.event_name}</h2>
            <p><strong>Location:</strong> ${eventData.college}, ${eventData.city}, ${eventData.state || ''}</p>
            <p><strong>Start Date:</strong> ${eventData.start_date || "N/A"}</p>
            <p><strong>Contact:</strong> ${eventData.contact_number || "N/A"}</p>
            <p><strong>Email:</strong> ${eventData.contact_email || "N/A"}</p>
            <p><strong>Event Type:</strong> ${eventData.event_type}</p>
            <p><strong>Event Fee:</strong> ${eventData.event_fee || "Free"}</p>
            <p><strong>Description:</strong> ${eventData.event_description}</p>
            <p><strong>Caption:</strong> ${eventData.event_caption}</p>
          </div>
        </div>
        <div class="popup-buttons">
          <button class="approve-btn">Approve</button>
          <button class="decline-btn">Decline</button>
        </div>
      `;
      popup.querySelector(".close-btn").addEventListener("click", function () {
        popup.remove();
      });
      document.body.appendChild(popup);
      // Close popup on outside click
setTimeout(() => {
  document.addEventListener("click", handleOutsideClick);
});

function handleOutsideClick(e) {
  const popupContent = popup.querySelector(".popup-content");
  if (!popupContent.contains(e.target)) {
    popup.remove();
    document.removeEventListener("click", handleOutsideClick);
  }
}

      document.querySelector(".approve-btn").addEventListener("click", async function () {
        try {
          await setDoc(doc(db, "verified_events", eventId), eventData);
          await deleteDoc(doc(db, "events", eventId));
          alert(`Event "${eventData.event_name}" Approved! ✅`);
          popup.remove();
          location.reload();
        } catch (error) {
          console.error("Error approving event:", error);
          alert("Failed to approve event. Try again!");
        }
      });
      document.querySelector(".decline-btn").addEventListener("click", async function () {
        if (confirm("Are you sure you want to decline (delete) this event? ❌")) {
          try {
            await deleteDoc(doc(db, "events", eventId));
            alert(`Event "${eventData.event_name}" Declined & Deleted! ❌`);
            popup.remove();
            location.reload();
          } catch (error) {
            console.error("Error declining event:", error);
            alert("Failed to decline event. Try again!");
          }
        }
      });
    }

    window.fetchScrapedData = fetchScrapedData;
    window.fetchUserEvents = fetchUserEvents;

    document.addEventListener("DOMContentLoaded", function () {
      fetchScrapedData();
    });
  </script>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById("sidebar");
    sidebar.classList.toggle("open");

    if (sidebar.classList.contains("open")) {
      document.addEventListener("click", closeSidebarOnClickOutside);
    } else {
      document.removeEventListener("click", closeSidebarOnClickOutside);
    }
  }

  function closeSidebarOnClickOutside(event) {
    const sidebar = document.getElementById("sidebar");
    const menuToggle = document.querySelector(".menu-toggle");

    // If the click is outside the sidebar and menu button, close it
    if (!sidebar.contains(event.target) && !menuToggle.contains(event.target)) {
      sidebar.classList.remove("open");
      document.removeEventListener("click", closeSidebarOnClickOutside);
    }
  }

  function showSection(sectionId, event) {
    event.preventDefault();
    const sections = ["scraped-data", "user-events", "settings"];
    sections.forEach(id => {
      document.getElementById(id).style.display = "none";
    });
    document.getElementById(sectionId).style.display = "block";
    if (sectionId === "scraped-data") fetchScrapedData();
    else if (sectionId === "user-events") fetchUserEvents();
  }
</script>
<script>
  document.getElementById("scrapeBtn").addEventListener("click", function () {
      fetch("http://127.0.0.1:5000/run-scraper", {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      })
      .then(response => response.json())
      .then(data => {
        const messageDiv = document.getElementById("successMessage");
        messageDiv.textContent = "Scraping started!"; // Set your desired success message
        messageDiv.style.color = "green"; // Set text color to green
        messageDiv.style.display = "block"; // Make the message div visible
        setTimeout(() => {
          messageDiv.style.display = "none"; // Hide the message div after 3 seconds
        }, 3000);
    })
      .catch(error => console.error("Error starting scraper:", error));
    });

    // Modal logic for adding new profile
    const addProfileBtn = document.getElementById("addProfileBtn");
    const addProfileModal = document.getElementById("addProfileModal");
    const closeModal = document.querySelector("#addProfileModal .close");
    const saveProfileBtn = document.getElementById("saveProfileBtn");

    addProfileBtn.addEventListener("click", () => {
      addProfileModal.style.display = "block";
    });

    closeModal.addEventListener("click", () => {
      addProfileModal.style.display = "none";
    });

    window.addEventListener("click", (event) => {
      if (event.target == addProfileModal) {
        addProfileModal.style.display = "none";
      }
    });

    saveProfileBtn.addEventListener("click", () => {
      const newProfile = document.getElementById("newProfileInput").value.trim();
      if (!newProfile) {
        alert("Please enter a profile username.");
        return;
      }
      // Send new profile to backend (adjust endpoint and method as needed)
      fetch("http://127.0.0.1:5000/admin/add-profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: newProfile })
      })
      .then(response => response.json())
      .then(data => {
        const messageDiv = document.getElementById("successMessage");
        if (data.message) {
          messageDiv.textContent = data.message; // Set the success message text
          messageDiv.style.color = "green"; // Set text color to green
          messageDiv.style.display = "block"; // Make the message div visible
          setTimeout(() => {
            messageDiv.style.display = "none"; // Hide the message div
          }, 3000);
        }   
      })

      .catch(error => {
        console.error("Error adding profile:", error);
        alert("Error adding profile.");
      });
    });

</script>

<script>
  // Get elements
  const promoteAdminBtn = document.getElementById("promoteAdminBtn");
  const promoteAdminModal = document.getElementById("promoteAdminModal");
  const closeAdminModal = document.querySelector("#promoteAdminModal .close");
  const promoteAdminSubmitBtn = document.getElementById("promoteAdminSubmitBtn");

  // Open the modal when the button is clicked
  promoteAdminBtn.addEventListener("click", () => {
    promoteAdminModal.style.display = "block";
  });

  // Close the modal when the "x" is clicked
  closeAdminModal.addEventListener("click", () => {
    promoteAdminModal.style.display = "none";
  });

  // Close the modal when clicking outside of it
  window.addEventListener("click", (event) => {
    if (event.target === promoteAdminModal) {
      promoteAdminModal.style.display = "none";
    }
  });

  // Handle the Promote button click
  promoteAdminSubmitBtn.addEventListener("click", async () => {
    const username = document.getElementById("adminUsernameInput").value.trim();
    if (!username) {
      alert("Please enter a username.");
      return;
    }

    try {
      const response = await fetch("http://127.0.0.1:5000/admin/promote", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: username })
      });
      const data = await response.json();
      if (response.ok) {
        const messageDiv = document.getElementById("successMessage");
        messageDiv.textContent = "User promoted to admin successfully"; // Set the success message text
        messageDiv.style.color = "green"; // Set text color to green
        messageDiv.style.display = "block"; // Make the message div visible
        setTimeout(() => {
        messageDiv.style.display = "none"; // Hide the message div after 3 seconds
        }, 3000);
      } else {
        const messageDiv = document.getElementById("successMessage");
        messageDiv.textContent = "failed to promote user"; // Set the success message text
        messageDiv.style.color = "red"; // Set text color to green
        messageDiv.style.display = "block"; // Make the message div visible
        setTimeout(() => {
        messageDiv.style.display = "none"; // Hide the message div after 3 seconds
        }, 3000);
        }
      promoteAdminModal.style.display = "none";
    } catch (error) {
      console.error("Error promoting user:", error);
      alert("An error occurred while promoting the user.");
    }
  });
</script>
<script>
  // Function to fetch and display the profiles
  async function fetchProfiles() {
    try {
      const response = await fetch("http://127.0.0.1:5000/admin/current-profiles");
      if (!response.ok) {
        throw new Error("Failed to fetch profiles.");
      }
      const data = await response.json();
      const profileListEl = document.getElementById("profileList");
      profileListEl.innerHTML = ""; // Clear the list
      data.profiles.forEach(profile => {
        const li = document.createElement("li");
        li.textContent = profile;
        profileListEl.appendChild(li);
      });
    } catch (error) {
      console.error("Error fetching profiles:", error);
    }
  }

  // Fetch the profiles when the page loads
  window.addEventListener("load", fetchProfiles);

  // Refresh list on button click
  document.getElementById("refreshProfilesBtn").addEventListener("click", fetchProfiles);
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const removeProfileBtn = document.getElementById("removeProfileBtn");
  const removeProfileModal = document.getElementById("removeProfileModal");
  const removeProfileInput = document.getElementById("removeProfileInput");
  const removeProfileSubmitBtn = document.getElementById("removeProfileSubmitBtn");
  const successMessageDiv = document.getElementById("successMessage");

  const closeButtons = document.querySelectorAll(".modal .close");

  removeProfileBtn.addEventListener("click", () => {
    removeProfileModal.style.display = "block";
  });

  closeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      btn.closest(".modal").style.display = "none";
    });
  });

  removeProfileSubmitBtn.addEventListener("click", async () => {
    const usernameToRemove = removeProfileInput.value.trim();
    if (!usernameToRemove) {
      alert("Please enter a profile username to remove.");
      return;
    }

    try {
      const response = await fetch("http://127.0.0.1:5000/admin/remove-profile", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username: usernameToRemove })
      });

      const data = await response.json();

      successMessageDiv.textContent = data.message || data.error || "Unknown response";
      successMessageDiv.style.color = response.ok ? "green" : "red";
      successMessageDiv.style.display = "block";
      setTimeout(() => {
        successMessageDiv.style.display = "none";
      }, 3000);

      if (response.ok) {
        removeProfileModal.style.display = "none";
        removeProfileInput.value = "";
      }
    } catch (err) {
      console.error(err);
    }
  });

  window.addEventListener("click", (e) => {
    if (e.target === removeProfileModal) {
      removeProfileModal.style.display = "none";
    }
  });
});

</script>
</body>
</html>
